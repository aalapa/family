<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Habit Tracker</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            color: white;
            min-height: 100vh;
            font-weight: 400;
            overflow-x: hidden;
        }

        /* Login Screen Styles */
        .login-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 40px;
        }

        .login-title {
            font-size: 4em;
            font-weight: 800;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
        }

        .login-subtitle {
            font-size: 1.5em;
            margin-bottom: 50px;
            opacity: 0.8;
            text-align: center;
        }

        .person-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 30px;
            max-width: 800px;
            width: 100%;
        }

        .person-card {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 40px 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .person-card:hover, .person-card:focus {
            transform: translateY(-5px);
            border-color: rgba(255,255,255,0.4);
            background: rgba(255,255,255,0.2);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .person-avatar {
            font-size: 4em;
            margin-bottom: 15px;
        }

        .person-name {
            font-size: 1.8em;
            font-weight: 600;
            text-transform: capitalize;
        }

        .person-card.veda {
            border-color: #ff6b9d;
        }
        .person-card.veda:hover {
            border-color: #ff6b9d;
            box-shadow: 0 10px 30px rgba(255, 107, 157, 0.3);
        }

        .person-card.radhika {
            border-color: #4ecdc4;
        }
        .person-card.radhika:hover {
            border-color: #4ecdc4;
            box-shadow: 0 10px 30px rgba(78, 205, 196, 0.3);
        }

        .person-card.aravind {
            border-color: #45b7d1;
        }
        .person-card.aravind:hover {
            border-color: #45b7d1;
            box-shadow: 0 10px 30px rgba(69, 183, 209, 0.3);
        }

        /* Main App Styles */
        .main-app {
            display: none;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            font-size: 2.5em;
        }

        .user-details h2 {
            font-size: 1.8em;
            font-weight: 600;
            text-transform: capitalize;
        }

        .user-details p {
            opacity: 0.8;
            margin-top: 5px;
        }

        .app-nav {
            display: flex;
            gap: 15px;
        }

        .nav-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-btn:hover, .nav-btn.active {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.4);
        }

        .logout-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            border-color: rgba(255,255,255,0.3);
        }

        /* Dashboard View */
        .dashboard-view {
            display: grid;
            gap: 25px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            opacity: 0.8;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
        }

        .category-card {
            background: rgba(255,255,255,0.08);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .category-title {
            font-size: 1.4em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .habit-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .habit-row:hover {
            background: rgba(255,255,255,0.1);
        }

        .habit-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .habit-name {
            font-size: 1.1em;
            font-weight: 500;
        }

        .habit-schedule {
            font-size: 0.8em;
            opacity: 0.7;
            background: rgba(255,255,255,0.1);
            padding: 4px 8px;
            border-radius: 12px;
        }

        .habit-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-indicator.completed { background: #22c55e; }
        .status-indicator.rest { background: #86efac; }
        .status-indicator.missed { background: rgba(255,255,255,0.3); }

        /* Calendar View */
        .calendar-view {
            display: none;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .calendar-nav {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .calendar-nav button {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
        }

        .calendar-day-header {
            text-align: center;
            padding: 15px;
            font-weight: 600;
            opacity: 0.8;
            font-size: 0.9em;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px;
            min-height: 40px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .calendar-day:hover {
            border-color: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .calendar-day.today {
            border: 2px solid #fbbf24;
            box-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        /* GitHub-style completion levels */
        .calendar-day.completion-0 {
            background: rgba(255,255,255,0.05);
        }

        .calendar-day.completion-1 {
            background: rgba(34, 197, 94, 0.2);
        }

        .calendar-day.completion-2 {
            background: rgba(34, 197, 94, 0.4);
        }

        .calendar-day.completion-3 {
            background: rgba(34, 197, 94, 0.6);
        }

        .calendar-day.completion-4 {
            background: rgba(34, 197, 94, 0.8);
        }

        .calendar-day.completion-5 {
            background: rgba(34, 197, 94, 1);
        }

        .day-number {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .day-number.hide {
            display: none;
        }

        .day-progress {
            display: none;
        }

        /* Day Detail Modal */
        .day-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .day-modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .day-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .day-modal-title {
            font-size: 1.5em;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }

        .close-btn:hover {
            opacity: 1;
        }

        .habit-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
        }

        .habit-entry-info {
            flex: 1;
        }

        .habit-entry-name {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .habit-entry-category {
            font-size: 0.8em;
            opacity: 0.7;
        }

        .status-buttons {
            display: flex;
            gap: 8px;
        }

        .status-btn {
            width: 40px;
            height: 40px;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            transition: all 0.3s ease;
        }

        .status-btn.active {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.2);
        }

        .status-btn.completed.active {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.3);
        }

        .status-btn.rest.active {
            border-color: #86efac;
            background: rgba(134, 239, 172, 0.3);
        }

        .status-btn.missed.active {
            border-color: #64748b;
            background: rgba(100, 116, 139, 0.3);
        }

        .loading {
            text-align: center;
            padding: 100px;
            font-size: 1.5em;
        }

        .error {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid #ef4444;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .login-title {
                font-size: 2.5em;
            }
            
            .person-selection {
                grid-template-columns: 1fr;
                max-width: 300px;
            }
            
            .categories-grid {
                grid-template-columns: 1fr;
            }
            
            .calendar-grid {
                padding: 10px;
            }
            
            .calendar-day {
                min-height: 60px;
                padding: 5px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <h1 class="login-title">👨‍👩‍👧‍👦 Family Habit Tracker</h1>
        <p class="login-subtitle">Choose your profile to continue</p>
        
        <div class="person-selection">
            <div class="person-card veda" onclick="loginPerson('veda')">
                <div class="person-avatar">👧</div>
                <div class="person-name">Veda</div>
            </div>
            
            <div class="person-card radhika" onclick="loginPerson('radhika')">
                <div class="person-avatar">👩</div>
                <div class="person-name">Radhika</div>
            </div>
            
            <div class="person-card aravind" onclick="loginPerson('aravind')">
                <div class="person-avatar">👨</div>
                <div class="person-name">Aravind</div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="main-app">
        <!-- Header -->
        <div class="app-header">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">👨</div>
                <div class="user-details">
                    <h2 id="userName">User</h2>
                    <p id="userStats">Loading...</p>
                </div>
            </div>
            
            <div class="app-nav">
                <button class="nav-btn active" onclick="showView('dashboard')">Dashboard</button>
                <button class="nav-btn" onclick="showView('calendar')">Calendar</button>
                <button class="nav-btn logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboardView" class="dashboard-view">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="todayCompletion">0%</div>
                    <div class="stat-label">Today's Progress</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="weekCompletion">0%</div>
                    <div class="stat-label">This Week</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="currentStreak">0</div>
                    <div class="stat-label">Current Streak</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="monthCompletion">0%</div>
                    <div class="stat-label">This Month</div>
                </div>
            </div>

            <div class="categories-grid" id="categoriesGrid">
                <!-- Categories will be populated here -->
            </div>
        </div>

        <!-- Calendar View -->
        <div id="calendarView" class="calendar-view">
            <div class="calendar-header">
                <h2 id="calendarTitle">June 2025</h2>
                <div class="calendar-nav">
                    <button onclick="changeMonth(-1)">← Previous</button>
                    <button onclick="goToToday()">Today</button>
                    <button onclick="changeMonth(1)">Next →</button>
                </div>
            </div>
            
            <div class="calendar-grid" id="calendarGrid">
                <!-- Calendar will be populated here -->
            </div>
        </div>
    </div>

    <!-- Day Detail Modal -->
    <div id="dayModal" class="day-modal">
        <div class="day-modal-content">
            <div class="day-modal-header">
                <h3 class="day-modal-title" id="dayModalTitle">Edit Day</h3>
                <button class="close-btn" onclick="closeDayModal()">&times;</button>
            </div>
            
            <div id="dayModalContent">
                <!-- Habit entries will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const APPS_SCRIPT_URL = 'YOUR_APPS_SCRIPT_URL_HERE'; // Replace with your deployed web app URL
        const SHEET_ID = '1w2JDjLzGSxorjlOZb9A7Hf6V0CDdLt_QpBBckX4er9A';
        const API_KEY = 'AIzaSyBZEQeeQHoX5Zak2dFlERfkW6atzPkg8tg';

        // Global state
        let currentUser = null;
        let habitsData = [];
        let entriesData = [];
        let currentView = 'dashboard';
        let currentDate = new Date();
        let selectedDate = null;

        // User avatars
        const userAvatars = {
            veda: '👧',
            radhika: '👩',
            aravind: '👨'
        };

        // Sample data for testing
        const SAMPLE_HABITS = [
            { person: 'veda', category: 'Learning', habit: 'Reading', schedule: 'daily', required: true },
            { person: 'veda', category: 'Learning', habit: 'Math Practice', schedule: 'weekdays', required: true },
            { person: 'veda', category: 'Learning', habit: 'Piano', schedule: 'mon,wed,fri', required: true },
            { person: 'veda', category: 'Health', habit: 'Exercise', schedule: 'daily', required: true },
            { person: 'radhika', category: 'Fitness', habit: 'Yoga', schedule: 'daily', required: true },
            { person: 'radhika', category: 'Fitness', habit: 'Walking', schedule: 'daily', required: false },
            { person: 'radhika', category: 'Wellness', habit: 'Meditation', schedule: 'daily', required: true },
            { person: 'aravind', category: 'Exercise', habit: 'Push-ups', schedule: 'daily', required: true },
            { person: 'aravind', category: 'Exercise', habit: 'Running', schedule: 'mon,wed,fri', required: true },
            { person: 'aravind', category: 'Reading', habit: 'Technical Books', schedule: 'daily', required: true }
        ];

        function generateSampleEntries() {
            const entries = [];
            const today = new Date();
            
            for (let i = 0; i < 30; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                SAMPLE_HABITS.forEach(habit => {
                    if (isHabitScheduledForDate(habit, date)) {
                        const rand = Math.random();
                        let status = 'missed';
                        
                        if (rand > 0.7) status = 'completed';
                        else if (rand > 0.6) status = 'rest';
                        
                        entries.push({
                            date: dateStr,
                            person: habit.person,
                            category: habit.category,
                            habit: habit.habit,
                            status: status
                        });
                    }
                });
            }
            
            return entries;
        }

        function isHabitScheduledForDate(habit, date) {
            const dayOfWeek = date.getDay(); // 0 = Sunday, 1 = Monday, etc.
            const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            const currentDay = dayNames[dayOfWeek];
            
            switch (habit.schedule) {
                case 'daily':
                    return true;
                case 'weekdays':
                    return dayOfWeek >= 1 && dayOfWeek <= 5;
                case 'weekends':
                    return dayOfWeek === 0 || dayOfWeek === 6;
                default:
                    // Custom schedule like "mon,wed,fri"
                    return habit.schedule.split(',').includes(currentDay);
            }
        }

        async function loadData() {
            try {
                console.log('Loading data from Google Apps Script...');
                
                if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL === 'https://script.google.com/macros/s/AKfycbxmR1zQstIn_ZeXrod0eji7TPuOqzN_ZuJlxDupc7TRY7O4AEll7adZBN22HJh-fCg_mg/exec') {
                    console.log('Apps Script URL not configured, using sample data');
                    habitsData = SAMPLE_HABITS;
                    entriesData = generateSampleEntries();
                    return;
                }
                
                const response = await fetch(APPS_SCRIPT_URL + '?action=getData', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    },
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    habitsData = data.habits || SAMPLE_HABITS;
                    entriesData = data.entries || [];
                    console.log('Successfully loaded data from Google Sheets:', {
                        habits: habitsData.length,
                        entries: entriesData.length
                    });
                } else {
                    throw new Error(data.error || 'Unknown error from Apps Script');
                }
                
            } catch (error) {
                console.error('Error loading data from Google Sheets:', error);
                console.log('Falling back to sample data');
                habitsData = SAMPLE_HABITS;
                entriesData = generateSampleEntries();
            }
        }

        function loginPerson(person) {
            currentUser = person;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            // Update user info
            document.getElementById('userAvatar').textContent = userAvatars[person];
            document.getElementById('userName').textContent = person.charAt(0).toUpperCase() + person.slice(1);
            
            // Load and display data
            loadData().then(() => {
                updateDashboard();
                updateCalendar();
            });
        }

        function logout() {
            currentUser = null;
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            
            // Reset navigation
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.nav-btn').classList.add('active');
            showView('dashboard');
        }

        function showView(view) {
            currentView = view;
            
            // Update navigation
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show/hide views
            document.getElementById('dashboardView').style.display = view === 'dashboard' ? 'block' : 'none';
            document.getElementById('calendarView').style.display = view === 'calendar' ? 'block' : 'none';
            
            if (view === 'calendar') {
                updateCalendar();
            }
        }

        function updateDashboard() {
            if (!currentUser) return;
            
            const userHabits = habitsData.filter(h => h.person === currentUser);
            const userEntries = entriesData.filter(e => e.person === currentUser);
            
            // Calculate stats
            const today = new Date().toISOString().split('T')[0];
            const todayEntries = userEntries.filter(e => e.date === today);
            const todayHabits = userHabits.filter(h => isHabitScheduledForDate(h, new Date()));
            
            const todayCompleted = todayEntries.filter(e => e.status === 'completed').length;
            const todayTotal = todayHabits.length;
            const todayCompletion = todayTotal > 0 ? Math.round((todayCompleted / todayTotal) * 100) : 0;
            
            // Update stats display
            document.getElementById('todayCompletion').textContent = todayCompletion + '%';
            document.getElementById('userStats').textContent = `${todayCompleted}/${todayTotal} habits completed today`;
            
            // Group habits by category
            const categories = {};
            userHabits.forEach(habit => {
                if (!categories[habit.category]) {
                    categories[habit.category] = [];
                }
                categories[habit.category].push(habit);
            });
            
            // Render categories
            const categoriesGrid = document.getElementById('categoriesGrid');
            categoriesGrid.innerHTML = Object.keys(categories).map(categoryName => {
                const categoryHabits = categories[categoryName];
                const habitsHtml = categoryHabits.map(habit => {
                    const todayEntry = todayEntries.find(e => e.habit === habit.habit);
                    const status = todayEntry ? todayEntry.status : 'missed';
                    const isScheduledToday = isHabitScheduledForDate(habit, new Date());
                    
                    return `
                        <div class="habit-row" onclick="openDayModal('${today}')">
                            <div class="habit-info">
                                <div class="habit-name">${habit.habit}</div>
                                <div class="habit-schedule">${habit.schedule}</div>
                            </div>
                            <div class="habit-status">
                                ${isScheduledToday ? `<div class="status-indicator ${status}"></div>` : ''}
                                <span>${isScheduledToday ? (status === 'completed' ? 'Done' : status === 'rest' ? 'Rest' : 'Pending') : 'Not scheduled'}</span>
                            </div>
                        </div>
                    `;
                }).join('');
                
                return `
                    <div class="category-card">
                        <div class="category-header">
                            <div class="category-title">${categoryName}</div>
                        </div>
                        ${habitsHtml}
                    </div>
                `;
            }).join('');
        }

        function updateCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Update calendar title
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('calendarTitle').textContent = `${monthNames[month]} ${year}`;
            
            // Generate calendar grid
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const calendarGrid = document.getElementById('calendarGrid');
            let calendarHtml = '';
            
            // Day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                calendarHtml += `<div class="calendar-day-header">${day}</div>`;
            });
            
            // Calendar days
            const currentDateObj = new Date();
            const todayStr = currentDateObj.toISOString().split('T')[0];
            
            for (let i = 0; i < 42; i++) { // 6 weeks * 7 days
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dateStr = date.toISOString().split('T')[0];
                const isCurrentMonth = date.getMonth() === month;
                const isToday = dateStr === todayStr;
                const isPastOrToday = dateStr <= todayStr;
                
                // Calculate completion for this day
                const dayEntries = entriesData.filter(e => e.person === currentUser && e.date === dateStr);
                const dayHabits = habitsData.filter(h => h.person === currentUser && isHabitScheduledForDate(h, date));
                
                let completionLevel = 0;
                if (dayHabits.length > 0) {
                    const completedTasks = dayEntries.filter(e => e.status === 'completed').length;
                    const completionPercentage = (completedTasks / dayHabits.length) * 100;
                    
                    // Map completion percentage to GitHub-style levels (0-5)
                    if (completionPercentage === 0) completionLevel = 0;
                    else if (completionPercentage <= 25) completionLevel = 1;
                    else if (completionPercentage <= 50) completionLevel = 2;
                    else if (completionPercentage <= 75) completionLevel = 3;
                    else if (completionPercentage < 100) completionLevel = 4;
                    else completionLevel = 5; // 100%
                }
                
                // Show date number only for today and future days
                const showDate = isToday || dateStr > todayStr;
                
                calendarHtml += `
                    <div class="calendar-day completion-${completionLevel} ${isCurrentMonth ? '' : 'other-month'} ${isToday ? 'today' : ''}" 
                         onclick="openDayModal('${dateStr}')"
                         title="${date.toDateString()}: ${dayHabits.length > 0 ? Math.round((dayEntries.filter(e => e.status === 'completed').length / dayHabits.length) * 100) : 0}% complete">
                        <div class="day-number ${showDate ? '' : 'hide'}">${date.getDate()}</div>
                    </div>
                `;
            }
            
            calendarGrid.innerHTML = calendarHtml;
        }

        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            updateCalendar();
        }

        function goToToday() {
            currentDate = new Date();
            updateCalendar();
        }

        function openDayModal(dateStr) {
            selectedDate = dateStr;
            const date = new Date(dateStr);
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('dayModalTitle').textContent = date.toLocaleDateString('en-US', options);
            
            // Get habits for this user and date
            const userHabits = habitsData.filter(h => h.person === currentUser);
            const scheduledHabits = userHabits.filter(h => isHabitScheduledForDate(h, date));
            const dayEntries = entriesData.filter(e => e.person === currentUser && e.date === dateStr);
            
            const modalContent = document.getElementById('dayModalContent');
            modalContent.innerHTML = scheduledHabits.map(habit => {
                const entry = dayEntries.find(e => e.habit === habit.habit);
                const currentStatus = entry ? entry.status : 'missed';
                
                return `
                    <div class="habit-entry">
                        <div class="habit-entry-info">
                            <div class="habit-entry-name">${habit.habit}</div>
                            <div class="habit-entry-category">${habit.category}</div>
                        </div>
                        <div class="status-buttons">
                            <button class="status-btn completed ${currentStatus === 'completed' ? 'active' : ''}" 
                                    onclick="updateHabitStatus('${habit.habit}', '${habit.category}', 'completed')">
                                ✅
                            </button>
                            <button class="status-btn rest ${currentStatus === 'rest' ? 'active' : ''}" 
                                    onclick="updateHabitStatus('${habit.habit}', '${habit.category}', 'rest')">
                                💤
                            </button>
                            <button class="status-btn missed ${currentStatus === 'missed' ? 'active' : ''}" 
                                    onclick="updateHabitStatus('${habit.habit}', '${habit.category}', 'missed')">
                                ❌
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('dayModal').style.display = 'flex';
        }

        function closeDayModal() {
            document.getElementById('dayModal').style.display = 'none';
            selectedDate = null;
        }

        async function updateHabitStatus(habit, category, status) {
            if (!selectedDate || !currentUser) return;
            
            // Update local data immediately (optimistic update)
            entriesData = entriesData.filter(e => 
                !(e.person === currentUser && e.date === selectedDate && e.habit === habit)
            );
            
            entriesData.push({
                date: selectedDate,
                person: currentUser,
                category: category,
                habit: habit,
                status: status
            });
            
            // Refresh the modal and views immediately
            openDayModal(selectedDate);
            updateDashboard();
            updateCalendar();
            
            // Save to Google Sheets in background
            try {
                if (APPS_SCRIPT_URL && APPS_SCRIPT_URL !== 'YOUR_APPS_SCRIPT_URL_HERE') {
                    console.log(`Saving ${habit} = ${status} for ${selectedDate} to Google Sheets...`);
                    
                    const response = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'updateEntry',
                            date: selectedDate,
                            person: currentUser,
                            category: category,
                            habit: habit,
                            status: status
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        console.log('Successfully saved to Google Sheets');
                    } else {
                        console.error('Error saving to Google Sheets:', result.error);
                        // Could show a notification to user here
                    }
                } else {
                    console.log('Apps Script not configured - change saved locally only');
                }
            } catch (error) {
                console.error('Error saving to Google Sheets:', error);
                // Could show a notification to user here
            }
        }

        // Keyboard navigation for Fire TV
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeDayModal();
            }
        });

        // Initialize the app
        window.addEventListener('load', () => {
            loadData();
        });

        // Click outside modal to close
        document.getElementById('dayModal').addEventListener('click', (e) => {
            if (e.target.id === 'dayModal') {
                closeDayModal();
            }
        });
    </script>
</body>
</html>
